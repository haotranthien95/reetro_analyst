# FastAPI Excel → PostgreSQL (orders)

This service accepts Excel uploads and writes rows into `public.orders` in PostgreSQL **by column order** (starting at `ma_dat_hang`), supports **override** by key fields, and exposes a stats API for charts.

## 1) Requirements
- Python 3.10+
- PostgreSQL 13+

## 2) Setup (Local)
```bash
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt
cp .env.example .env  # then edit .env
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
```

Open:
- Upload page: http://localhost:8000/
- Health:      http://localhost:8000/healthz
- Stats API:   GET /api/stats/daily?start=2025-08-01&end=2025-08-31

## 3) Environment variables
- `DATABASE_URL` (required) — e.g. `postgresql://user:pass@host:5432/db`  
  If your password has special chars (e.g. `@`), URL-encode it: `@` → `%40`.
- `OVERRIDE_KEY_FIELDS` (optional) — comma-separated key fields used to detect duplicates (default: `ma_dat_hang,ma_hang`).
- `CORS_ALLOW_ORIGINS` (optional) — comma-separated origins for CORS (`*` by default).

## 4) Docker
```bash
docker build -t excel-orders:latest .
docker run --env-file .env -p 8000:8000 excel-orders:latest
```

## 5) Docker Compose
```bash
docker compose up --build
```

## 6) PostgreSQL prerequisites
```sql
CREATE EXTENSION IF NOT EXISTS pgcrypto; -- for gen_random_uuid()
CREATE INDEX IF NOT EXISTS idx_orders_thoigian ON public.orders (thoi_gian);
-- Optional: enforce uniqueness for override keys
-- CREATE UNIQUE INDEX IF NOT EXISTS ux_orders_madh_mahang ON public.orders (ma_dat_hang, ma_hang);
```

## 7) Excel column order
From left to right (no header mapping):
```
ma_dat_hang, ma_hoa_don, ma_van_don, dia_chi_lay_hang, thoi_gian, thoi_gian_tao,
ma_khach_hang, ten_khach_hang, dien_thoai, dia_chi_khach_hang, khu_vuc, phuong_xa,
nguoi_nhan_dat, kenh_ban, nguoi_tao, doi_tac_giao_hang, nguoi_nhan, dien_thoai_nguoi_nhan,
dia_chi_nguoi_nhan, khu_vuc_nguoi_nhan, xa_phuong_nguoi_nhan, dich_vu, trong_luong,
dai, rong, cao, phi_tra_doi_tac_giao_hang, ghi_chu, tong_tien_hang, giam_gia_phieu_dat,
thu_khac, khach_da_tra, tien_mat, the, chuyen_khoan, vi, diem, don_vi_tinh,
thoi_gian_giao_hang, trang_thai, ma_hang, ma_vach, ten_hang, thuong_hieu, ghi_chu_hang_hoa,
so_luong, don_gia, giam_gia_pham_tram, giam_gia, gia_ban, thanh_tien
```

## 8) API
- `GET /` — simple upload form.
- `POST /upload-excel` — body: multipart form with `file` (.xlsx) and optional `override=true`.
- `GET /api/stats/daily?start=YYYY-MM-DD&end=YYYY-MM-DD` → `[{"ngay_trong_thang":1,"tong_gia_tri":289000000}, ...]`
- `GET /healthz` — health check.

## 9) Notes
- `id` is generated by DB (`gen_random_uuid()`), not read from Excel.
- Blank cells → `NULL`. Numeric parsing handles commas and spaces.
- `end` is inclusive in stats by using `< end + 1 day`.
```
```

---

## requirements.txt
```txt
fastapi
uvicorn
pandas
openpyxl
psycopg[binary]
python-multipart
pydantic
python-dotenv
```

---

## .env.example
```env
# Required
DATABASE_URL=postgresql://user:pass@localhost:5432/yourdb

# Optional
OVERRIDE_KEY_FIELDS=ma_dat_hang,ma_hang
CORS_ALLOW_ORIGINS=*
```

---

## .gitignore
```gitignore
.venv/
__pycache__/
*.pyc
*.pyo
*.pyd
.env
.cache/
.idea/
.vscode/
.DS_Store
```

---

## Dockerfile
```Dockerfile
FROM python:3.11-slim

ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

WORKDIR /app

# System deps for pandas/openpyxl/psycopg
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    libpq-dev \
 && rm -rf /var/lib/apt/lists/*

COPY requirements.txt ./
RUN pip install --no-cache-dir -r requirements.txt

COPY app ./app
COPY .env* ./

EXPOSE 8000
CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]

# uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload